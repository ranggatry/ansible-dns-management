#!/bin/bash

set -o pipefail
set -e

## get args
distribution=$1
reverse_zone_prefix=$2

# Convert reverse_zone_prefix string to an array reverse_zone_array
IFS=' ' read -ra reverse_zone_array <<< "$reverse_zone_prefix"

## check condition wether distribution is debian or redhat family
if [ "$distribution" == "Ubuntu" ] || [ "$distribution" == "Debian" ]; then
    backup_filename="/etc/bind/db.ji_$(date +%Y%m%d)"
    i=1
    while [ -f "$backup_filename_${i}" ]; do
        let i++
    done
    backup_filename="${backup_filename}_${i}"
    if [ -f /etc/bind/db.ji ]; then
      sudo cp -n /etc/bind/db.ji "$backup_filename"
      sudo cp {{ home }}/db.conf /etc/bind/db.ji
      for reverse_zone in "${reverse_zone_array[@]}"; do
        sudo cp {{ home }}/db-"$reverse_zone"-reverse.conf /etc/bind/db."$reverse_zone".in-addr.arpa
      done
      zonefile="/etc/bind/db.ji"
      bind_service="bind9"
    else
      sudo cp {{ home }}/db.conf /etc/bind/db.ji
      for reverse_zone in "${reverse_zone_array[@]}"; do
        sudo cp {{ home }}/db-"$reverse_zone"-reverse.conf /etc/bind/db."$reverse_zone".in-addr.arpa
      done
      zonefile="/etc/bind/db.ji"
      bind_service="bind9"
    fi


elif [ "$distribution" == "CentOS" ] || [ "$distribution" == "Red Hat Enterprise Linux" ] || [ "$distribution" == "RedHat" ]; then
    backup_filename="/etc/named/zones/db.ji_$(date +%Y%m%d)"
    i=1
    while [ -f "$backup_filename_${i}" ]; do
        let i++
    done
    backup_filename="${backup_filename}_${i}"
    if [ -f /etc/named/zones/db.ji ]; then
      sudo cp -n /etc/named/zones/db.ji "$backup_filename"
      sudo cp {{ home }}/db.conf /etc/named/zones/db.ji
      for reverse_zone in "${reverse_zone_array[@]}"; do
        sudo cp {{ home }}/db-"$reverse_zone"-reverse.conf /etc/named/zones/db."$reverse_zone".in-addr.arpa
      done
      zonefile="/etc/named/zones/db.ji"
      bind_service="named.service"
    else
      sudo cp {{ home }}/db.conf /etc/named/zones/db.ji
      for reverse_zone in "${reverse_zone_array[@]}"; do
        sudo cp {{ home }}/db-"$reverse_zone"-reverse.conf /etc/named/zones/db."$reverse_zone".in-addr.arpa
      done
      zonefile="/etc/named/zones/db.ji"
      bind_service="named.service"
    fi

else
    echo "Error: Distribution $distribution is not yet supported"
    exit 1
fi


## check zonefile
if [ -f $zonefile ]; then
    if named-checkzone -k fail ji $zonefile >/dev/null 2>&1; then
        if named-checkconf >/dev/null 2>&1; then
            echo "named checked success"
            sudo systemctl restart $bind_service
        else
            echo "Error: Invalid BIND configuration"
            exit 1
        fi
    else
        echo "Error: Invalid zone file $zonefile"
        exit 1
    fi
else
    echo "Error: No zone file found at $zonefile"
    exit 1
fi
